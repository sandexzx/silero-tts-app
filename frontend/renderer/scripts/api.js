// –ü—É—Ç—å: /home/zverev/sandbox/Electron/silero-tts-app/frontend/renderer/scripts/api.js
class ApiClient {
  constructor() {
    // –ù–∞–¥–µ–∂–Ω–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π 
    if (!window.api || !window.api.API_URL) {
      console.error("üî• window.api –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ!");
      this.apiUrl = 'http://127.0.0.1:8000'; // –§–æ–ª–ª–±—ç–∫
    } else {
      this.apiUrl = window.api.API_URL;
    }
    this.lastSynthesisResult = null;
    console.log("üì° ApiClient —Å–æ–∑–¥–∞–Ω —Å URL:", this.apiUrl);
  }
  
    async checkServerStatus() {
      console.log("–ü—Ä–æ–≤–µ—Ä—è—é —Å–µ—Ä–≤–µ—Ä –ø–æ –∞–¥—Ä–µ—Å—É:", this.apiUrl + "/health"); // –ú–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
      try {
        const health = await window.api.checkHealth(); // –í—ã–∑—ã–≤–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é –∏–∑ preload
        console.log("–û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞ (checkServerStatus):", health); // –û—Ç–ª–∞–¥–∫–∞

        // [!!!] –ü–†–ê–í–ò–õ–¨–ù–ê–Ø –ü–†–û–í–ï–†–ö–ê [!!!]
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –æ—Ç–≤–µ—Ç —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, —ç—Ç–æ –æ–±—ä–µ–∫—Ç –∏ –µ–≥–æ —Å—Ç–∞—Ç—É—Å –∏–º–µ–Ω–Ω–æ 'ok'
        if (health && typeof health === 'object' && health.status === 'ok') {
          console.log("–°–µ—Ä–≤–µ—Ä –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –±–æ–¥—Ä—è—á–∫–æ–º! ‚úÖ"); // –û–±–Ω–æ–≤–∏–º –ª–æ–≥ –¥–ª—è —è—Å–Ω–æ—Å—Ç–∏
          return true; // –°–µ—Ä–≤–µ—Ä –¥–æ—Å—Ç—É–ø–µ–Ω
        } else {
          // –õ–æ–≥–∏—Ä—É–µ–º, –ø–æ—á–µ–º—É —Å—á–∏—Ç–∞–µ–º —Å–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã–º
          if (!health) {
            console.log("–û—Ç–≤–µ—Ç –æ—Ç checkHealth –ø—É—Å—Ç–æ–π.");
          } else if (typeof health !== 'object') {
            console.log("–û—Ç–≤–µ—Ç –æ—Ç checkHealth –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –æ–±—ä–µ–∫—Ç–æ–º:", health);
          } else {
            console.log("–°—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–µ—Ä–∞ –Ω–µ 'ok':", health.status, "| –î–µ—Ç–∞–ª–∏:", health.error || '–ù–µ—Ç –¥–µ—Ç–∞–ª–µ–π');
          }
          return false; // –°–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –∏–ª–∏ –≤–µ—Ä–Ω—É–ª –æ—à–∏–±–∫—É
        }
      } catch (error) { // –≠—Ç–∞ –æ—à–∏–±–∫–∞ –ª–æ–≤–∏—Ç—Å—è, –µ—Å–ª–∏ window.api.checkHealth –≤—ã–±—Ä–æ—Å–∏–ª –∏—Å–∫–ª—é—á–µ–Ω–∏–µ (–º–∞–ª–æ–≤–µ—Ä–æ—è—Ç–Ω–æ –∏–∑-–∑–∞ try/catch –≤–Ω—É—Ç—Ä–∏ preload)
        console.error('–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–∑–æ–≤–µ window.api.checkHealth:', error);
        return false;
      }
    }
  
    async getSpeakers() {
      try {
        const response = await window.api.getSpeakers();
        if (response && response.speakers) {
          return response.speakers;
        }
        return [];
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ –≥–æ–ª–æ—Å–æ–≤:', error);
        return [];
      }
    }
  
    async synthesize(text, speaker = 'xenia', sampleRate = 48000, useSSML = false) {
      try {
        const response = await window.api.synthesize(text, speaker, sampleRate, useSSML);
        
        if (response.error) {
          throw new Error(response.error);
        }
        
        this.lastSynthesisResult = response;
        return response;
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ —Å–∏–Ω—Ç–µ–∑–∞ —Ä–µ—á–∏:', error);
        throw error;
      }
    }
  
    async saveAudioFile() {
      if (!this.lastSynthesisResult || !this.lastSynthesisResult.path) {
        throw new Error('–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∞—É–¥–∏–æ—Ñ–∞–π–ª–æ–≤ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
      }
  
      try {
        const savedPath = await window.api.saveAudioFile(this.lastSynthesisResult.path);
        return savedPath;
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∞—É–¥–∏–æ—Ñ–∞–π–ª–∞:', error);
        throw error;
      }
    }
    
    getAudioUrl(filename) {
      return `${window.api.API_URL}/audio/${filename}`;
    }
  }
  
  // –°–æ–∑–¥–∞–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä API –∫–ª–∏–µ–Ω—Ç–∞
  const apiClient = new ApiClient();